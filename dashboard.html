<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Terminal</title>
    <style>
        :root {
            --bg-app: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --text-tertiary: #C7C7CC;
            --accent-black: #1C1C1E;
            --accent-track: #E5E5EA;
            --gradient-bull: linear-gradient(135deg, #6BF3D6 0%, #4FA3FF 100%);
            --gradient-bear: linear-gradient(135deg, #FF6B95 0%, #FF9F4F 100%);
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 12px;
            --radius-pill: 999px;
            --space-xs: 4px;
            --space-s: 8px;
            --space-m: 16px;
            --space-l: 24px;
            --shadow-card: 0 4px 24px rgba(0,0,0,0.04);
            --shadow-float: 0 8px 32px rgba(0,0,0,0.08);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-size: 13px;
            -webkit-font-smoothing: antialiased;
        }

        .layout {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            grid-template-rows: 60px 1fr 280px;
            gap: var(--space-m);
            padding: var(--space-m);
            height: 100%;
            width: 100%;
        }

        header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-s);
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-dot {
            width: 10px;
            height: 10px;
            background: var(--text-primary);
            border-radius: 50%;
        }

        .nav-pills {
            background: var(--bg-card);
            padding: 4px;
            border-radius: var(--radius-pill);
            display: flex;
            gap: 2px;
            box-shadow: var(--shadow-card);
        }

        .nav-item {
            padding: 8px 20px;
            border-radius: var(--radius-pill);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .nav-item.active {
            background: #fff;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .account-info {
            display: flex;
            align-items: center;
            gap: var(--space-m);
            font-weight: 600;
        }

        .account-value {
            font-size: 16px;
        }

        .timestamp {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .panel {
            background: var(--bg-card);
            border-radius: var(--radius-m);
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .panel-header {
            padding: var(--space-m);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 15px;
            font-weight: 700;
        }

        .portfolio-panel {
            grid-column: 1;
            grid-row: 2 / span 2;
        }

        .portfolio-stats {
            padding: 0 var(--space-m) var(--space-m) var(--space-m);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--bg-app);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .text-label {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .text-value {
            font-weight: 600;
        }

        .active-coins {
            flex: 1;
            overflow-y: auto;
        }

        .market-item {
            padding: 12px var(--space-m);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--bg-app);
            cursor: pointer;
        }

        .market-item:hover {
            background-color: rgba(0,0,0,0.02);
        }

        .pair-name {
            font-weight: 600;
            font-size: 14px;
        }

        .pair-vol {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .change-pill {
            padding: 4px 8px;
            border-radius: var(--radius-pill);
            font-size: 11px;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }

        .change-pill.up {
            background: rgba(52, 199, 89, 0.1);
            color: #34C759;
        }

        .change-pill.down {
            background: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
        }

        .signals-panel {
            grid-column: 2;
            grid-row: 2;
        }

        .overall-signal {
            padding: var(--space-m);
            text-align: center;
            border-bottom: 1px solid var(--bg-app);
        }

        .big-price {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .signal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-m);
            padding: var(--space-m);
        }

        .signal-card {
            background: var(--bg-app);
            border-radius: var(--radius-s);
            padding: var(--space-m);
            text-align: center;
        }

        .signal-score {
            font-size: 24px;
            font-weight: 700;
            margin: var(--space-s) 0;
        }

        .signal-metrics {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: var(--space-s);
        }

        .chart-area {
            flex: 1;
            padding: var(--space-m);
            display: flex;
            flex-direction: column;
        }

        .chart-container {
            flex: 1;
            display: flex;
            align-items: end;
            gap: 2px;
            padding: var(--space-m) 0;
        }

        .chart-bar {
            flex: 1;
            background: var(--accent-track);
            border-radius: 2px;
            min-height: 4px;
            transition: all 0.2s ease;
        }

        .chart-bar.positive {
            background: #34C759;
        }

        .chart-bar.negative {
            background: #FF3B30;
        }

        .positions-panel {
            grid-column: 3;
            grid-row: 2;
        }

        .book-table {
            width: 100%;
            border-collapse: collapse;
            font-family: "SF Mono", "Roboto Mono", monospace;
            font-size: 11px;
        }

        .book-table th {
            text-align: left;
            color: var(--text-secondary);
            font-weight: 500;
            padding: 8px 12px;
        }

        .book-table td {
            padding: 4px 12px;
        }

        .ask-row td {
            color: #FF3B30;
        }

        .bid-row td {
            color: #34C759;
        }

        .pnl-divider {
            padding: var(--space-m);
            text-align: center;
            border-top: 1px solid var(--bg-app);
            border-bottom: 1px solid var(--bg-app);
            font-weight: 700;
        }

        .quick-stats {
            padding: var(--space-m);
        }

        .quick-stats .stat-item {
            padding: 8px 0;
        }

        .recent-trades {
            grid-column: 2;
            grid-row: 3;
        }

        .tab-row {
            padding: 0 var(--space-m);
            border-bottom: 1px solid var(--bg-app);
            display: flex;
            gap: 20px;
        }

        .tab {
            padding: 16px 0;
            font-weight: 600;
            color: var(--text-secondary);
            position: relative;
            cursor: pointer;
        }

        .tab.active {
            color: var(--text-primary);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--text-primary);
        }

        .trades-content {
            flex: 1;
            overflow-y: auto;
        }

        .history-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            padding: 12px var(--space-m);
            border-bottom: 1px solid var(--bg-app);
            font-size: 12px;
        }

        .trade-direction {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            background: var(--bg-app);
            border-radius: 4px;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
        }

        .status-badge.win {
            background: rgba(52, 199, 89, 0.1);
            color: #34C759;
        }

        .status-badge.loss {
            background: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
        }

        .engine-status {
            grid-column: 3;
            grid-row: 3;
        }

        .regime-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-m);
            border-bottom: 1px solid var(--bg-app);
        }

        .regime-pill {
            padding: 6px 12px;
            background: var(--gradient-bull);
            color: white;
            border-radius: var(--radius-pill);
            font-weight: 600;
            font-size: 11px;
        }

        .regime-pill.bear {
            background: var(--gradient-bear);
        }

        .engine-weights {
            padding: var(--space-m);
        }

        .weight-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-s);
        }

        .weight-bar {
            flex: 1;
            height: 4px;
            background: var(--accent-track);
            border-radius: 2px;
            margin: 0 var(--space-s);
            overflow: hidden;
        }

        .weight-fill {
            height: 100%;
            background: var(--accent-black);
            transition: width 0.3s ease;
        }

        .confidence-score {
            text-align: center;
            padding: var(--space-m);
            border-top: 1px solid var(--bg-app);
        }

        /* View states for nav switching */
        .layout[data-view="signals"] .portfolio-panel,
        .layout[data-view="signals"] .positions-panel,
        .layout[data-view="signals"] .recent-trades,
        .layout[data-view="signals"] .engine-status { opacity: 0.3; pointer-events: none; }
        .layout[data-view="signals"] .signals-panel { box-shadow: var(--shadow-float); z-index: 2; }

        .layout[data-view="positions"] .portfolio-panel,
        .layout[data-view="positions"] .signals-panel,
        .layout[data-view="positions"] .recent-trades,
        .layout[data-view="positions"] .engine-status { opacity: 0.3; pointer-events: none; }
        .layout[data-view="positions"] .positions-panel { box-shadow: var(--shadow-float); z-index: 2; }

        .layout[data-view="history"] .portfolio-panel,
        .layout[data-view="history"] .signals-panel,
        .layout[data-view="history"] .positions-panel,
        .layout[data-view="history"] .engine-status { opacity: 0.3; pointer-events: none; }
        .layout[data-view="history"] .recent-trades { box-shadow: var(--shadow-float); z-index: 2; }

        .layout > .panel { transition: opacity 0.3s ease, box-shadow 0.3s ease; }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #D1D1D6;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-dot"></div>
            Nova Terminal
        </div>
        <nav class="nav-pills" id="navPills">
            <div class="nav-item active" data-view="dashboard">Dashboard</div>
            <div class="nav-item" data-view="signals">Signals</div>
            <div class="nav-item" data-view="positions">Positions</div>
            <div class="nav-item" data-view="history">History</div>
        </nav>
        <div class="account-info">
            <div class="account-value" id="accountValue">$24,573.82</div>
            <div class="timestamp" id="timestamp">22:24 UTC</div>
        </div>
    </header>

    <div class="layout">
        <!-- Portfolio Panel -->
        <div class="panel portfolio-panel">
            <div class="panel-header">
                <div class="panel-title">Portfolio</div>
            </div>
            <div class="portfolio-stats">
                <div class="stat-item">
                    <div class="text-label">Base USDC</div>
                    <div class="text-value" id="baseUSDC">$12,450.00</div>
                </div>
                <div class="stat-item">
                    <div class="text-label">Base ETH</div>
                    <div class="text-value" id="baseETH">2.847 ETH</div>
                </div>
                <div class="stat-item">
                    <div class="text-label">HL Balance</div>
                    <div class="text-value" id="hlBalance">$8,923.45</div>
                </div>
                <div class="stat-item">
                    <div class="text-label">Total Value</div>
                    <div class="text-value" id="totalValue">$24,573.82</div>
                </div>
            </div>
            <div class="panel-header">
                <div class="panel-title">Active Coins</div>
            </div>
            <div class="active-coins">
                <div style="padding:12px 16px;color:var(--text-secondary)">Loading coins...</div>
            </div>
        </div>

        <!-- Signals Panel -->
        <div class="panel signals-panel">
            <div class="panel-header">
                <div class="panel-title">Signals</div>
            </div>
            <div class="overall-signal">
                <div class="text-label">Overall Signal</div>
                <div class="big-price" id="overallSignal" style="color: var(--text-secondary);">—</div>
            </div>
            <div class="signal-grid">
                <div class="signal-card">
                    <div class="pair-name">ETH</div>
                    <div class="signal-score change-pill up">+75</div>
                    <div class="signal-metrics">
                        <span>WT: 0.8</span>
                        <span>RSI: 65</span>
                        <span>Bull</span>
                    </div>
                </div>
                <div class="signal-card">
                    <div class="pair-name">BTC</div>
                    <div class="signal-score change-pill up">+45</div>
                    <div class="signal-metrics">
                        <span>WT: 0.4</span>
                        <span>RSI: 58</span>
                        <span>Bull</span>
                    </div>
                </div>
                <div class="signal-card">
                    <div class="pair-name">SOL</div>
                    <div class="signal-score change-pill down">-20</div>
                    <div class="signal-metrics">
                        <span>WT: -0.3</span>
                        <span>RSI: 42</span>
                        <span>Bear</span>
                    </div>
                </div>
                <div class="signal-card">
                    <div class="pair-name">HYPE</div>
                    <div class="signal-score change-pill up">+85</div>
                    <div class="signal-metrics">
                        <span>WT: 0.9</span>
                        <span>RSI: 72</span>
                        <span>Bull</span>
                    </div>
                </div>
            </div>
            <div class="chart-area">
                <div class="text-label">Signal History (24h)</div>
                <div class="chart-container" id="signalChart">
                    <!-- Chart bars will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Open Positions Panel -->
        <div class="panel positions-panel">
            <div class="panel-header">
                <div class="panel-title">Open Positions</div>
            </div>
            <table class="book-table">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Size</th>
                        <th>Entry</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="4" style="padding:20px 12px;color:var(--text-secondary);text-align:center;">Loading...</td></tr>
                </tbody>
            </table>
            <div class="pnl-divider" style="color: var(--text-secondary);">
                Loading...
            </div>
            <div class="quick-stats">
                <div class="stat-item"><div class="text-label">Loading...</div><div class="text-value">—</div></div>
            </div>
        </div>

        <!-- Recent Trades Panel -->
        <div class="panel recent-trades">
            <div class="panel-header">
                <div class="panel-title">Activity</div>
            </div>
            <div class="tab-row" id="activityTabs">
                <div class="tab active" data-tab="trades">Recent Trades</div>
                <div class="tab" data-tab="sniper">Sniper Alerts</div>
                <div class="tab" data-tab="activity">Activity</div>
            </div>
            <div class="trades-content" id="tabContent-trades">
                <div style="padding:20px;color:var(--text-secondary);text-align:center;">Loading...</div>
            </div>
            <div class="trades-content" id="tabContent-sniper" style="display:none">
                <div style="padding:20px;color:var(--text-secondary);text-align:center;">Loading...</div>
            </div>
            <div class="trades-content" id="tabContent-activity" style="display:none">
                <div style="padding:20px;color:var(--text-secondary);text-align:center;">Loading...</div>
            </div>
        </div>

        <!-- Engine Status Panel -->
        <div class="panel engine-status">
            <div class="panel-header">
                <div class="panel-title">Engine Status</div>
            </div>
            <div class="regime-indicator">
                <div class="text-label">Market Regime</div>
                <div class="regime-pill">BULL</div>
            </div>
            <div class="engine-weights">
                <div class="text-label" style="margin-bottom: var(--space-s);">Engine Weights</div>
                <div class="weight-item">
                    <span>Trend</span>
                    <div class="weight-bar"><div class="weight-fill" style="width: 75%;"></div></div>
                    <span>75%</span>
                </div>
                <div class="weight-item">
                    <span>Mean Rev</span>
                    <div class="weight-bar"><div class="weight-fill" style="width: 45%;"></div></div>
                    <span>45%</span>
                </div>
                <div class="weight-item">
                    <span>Momentum</span>
                    <div class="weight-bar"><div class="weight-fill" style="width: 60%;"></div></div>
                    <span>60%</span>
                </div>
            </div>
            <div class="confidence-score">
                <div class="text-label">Confidence Score</div>
                <div class="text-value" style="font-size: 18px; color: #34C759;">87%</div>
                <div class="text-label" style="margin-top: var(--space-xs);">Last calibration: 2h ago</div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================================
        // NOVA TERMINAL — LIVE DATA ENGINE
        // Fetches real data from APIs + static dashboard-data.json
        // =====================================================================

        const WALLET = '0xf59F993bc53f8eC2C0278FAF37fB86dE25DB387A';
        const USDC_ADDR = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
        const DATA_URL = 'dashboard-data.json'; // Generated by generate-dashboard-data.js

        // State
        let dashboardData = null;
        let livePrices = {};

        // ── Formatters ──
        const fmt = (n, d=2) => n !== null && n !== undefined ? Number(n).toFixed(d) : '—';
        const fmtUSD = (n) => n !== null && n !== undefined ? '$' + Number(n).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}) : '—';
        const fmtSign = (n) => n > 0 ? `+${fmt(n)}` : fmt(n);
        const fmtTime = (ts) => { try { return new Date(ts).toLocaleTimeString('en-US', {hour12:false, timeZone:'UTC', hour:'2-digit', minute:'2-digit'}); } catch(e) { return '—'; } };

        // ── Live Price Fetcher (Coinbase + HL) ──
        async function fetchLivePrices() {
            const coins = ['ETH','BTC','SOL'];
            const results = {};
            await Promise.allSettled(coins.map(async coin => {
                try {
                    const r = await fetch(`https://api.exchange.coinbase.com/products/${coin}-USD/ticker`);
                    const d = await r.json();
                    results[coin] = parseFloat(d.price);
                } catch(e) {}
            }));
            try {
                const r = await fetch('https://api.hyperliquid.xyz/info', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({type:'allMids'})
                });
                const d = await r.json();
                if (d.HYPE) results.HYPE = parseFloat(d.HYPE);
            } catch(e) {}
            livePrices = results;
            return results;
        }

        // ── HL Account State (live) ──
        async function fetchHLState() {
            try {
                const r = await fetch('https://api.hyperliquid.xyz/info', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({type:'clearinghouseState', user: WALLET})
                });
                return await r.json();
            } catch(e) { return null; }
        }

        // ── Load static data (from generate-dashboard-data.js) ──
        async function fetchDashboardData() {
            try {
                // Try relative path first (GitHub Pages), then absolute
                const r = await fetch(DATA_URL + '?t=' + Date.now());
                if (r.ok) return await r.json();
            } catch(e) {}
            return null;
        }

        // ── Render Functions ──
        function renderAccount(data, hl, prices) {
            const baseUSDC = data?.account?.baseUSDC ?? 0;
            const ethAmt = (data?.account?.baseETH ?? 0) + (data?.account?.baseWETH ?? 0);
            const ethPrice = prices.ETH || data?.prices?.ETH || 0;
            const ethValue = ethAmt * ethPrice;
            const hlValue = hl ? parseFloat(hl.marginSummary?.accountValue || 0) : (data?.account?.hlAccountValue ?? 0);
            const total = baseUSDC + ethValue + hlValue;

            document.getElementById('accountValue').textContent = fmtUSD(total);
            document.getElementById('baseUSDC').textContent = fmtUSD(baseUSDC);
            document.getElementById('baseETH').textContent = `${fmt(ethAmt, 4)} ETH (${fmtUSD(ethValue)})`;
            document.getElementById('hlBalance').textContent = fmtUSD(hlValue);
            document.getElementById('totalValue').textContent = fmtUSD(total);
        }

        function renderCoins(data, prices) {
            const container = document.querySelector('.active-coins');
            if (!container) return;
            container.innerHTML = '';
            
            const coreCoins = ['ETH', 'BTC', 'SOL', 'HYPE'];
            const dynamicCoins = (data?.coins?.dynamic || []).map(c => c.coin);
            const allCoins = [...coreCoins, ...dynamicCoins];

            allCoins.forEach(coin => {
                const price = prices[coin] || data?.prices?.[coin] || 0;
                const isDynamic = dynamicCoins.includes(coin);
                const dynInfo = (data?.coins?.dynamic || []).find(c => c.coin === coin);
                const signal = data?.signals?.overall ?? 0; // per-coin signals would need multi-coin snapshot

                const item = document.createElement('div');
                item.className = 'market-item';
                item.innerHTML = `
                    <div>
                        <div class="pair-name">${coin}${isDynamic ? ' ⚡' : ''}</div>
                        <div class="pair-vol">${price > 0 ? fmtUSD(price) : '—'}${isDynamic && dynInfo ? ' · ' + dynInfo.reason.split(',')[1]?.trim() : ''}</div>
                    </div>
                    ${isDynamic && dynInfo ? `<div class="change-pill ${dynInfo.reason.includes('+') ? 'up' : 'down'}">${dynInfo.reason.split(',')[1]?.trim() || ''}</div>` : ''}
                `;
                container.appendChild(item);
            });
        }

        function renderSignals(data) {
            const sig = data?.signals;
            if (!sig) return;

            const overallEl = document.getElementById('overallSignal');
            overallEl.textContent = sig.overall > 0 ? `+${sig.overall}` : String(sig.overall);
            overallEl.style.color = sig.overall > 0 ? '#34C759' : sig.overall < 0 ? '#FF3B30' : 'var(--text-secondary)';

            // Update signal cards with real data
            const cards = document.querySelectorAll('.signal-card');
            const coinData = [
                { name: 'ETH', wt: sig.wt1, rsi: sig.rsi, score: sig.overall, action: sig.action },
                { name: 'BTC', wt: null, rsi: null, score: null, action: '—' },
                { name: 'SOL', wt: null, rsi: null, score: null, action: '—' },
                { name: 'HYPE', wt: null, rsi: null, score: null, action: '—' },
            ];
            cards.forEach((card, i) => {
                const c = coinData[i];
                if (!c) return;
                const score = c.score;
                const scoreClass = score > 0 ? 'up' : score < 0 ? 'down' : '';
                card.innerHTML = `
                    <div class="pair-name">${c.name}</div>
                    <div class="signal-score change-pill ${scoreClass}">${score !== null ? fmtSign(score) : '—'}</div>
                    <div class="signal-metrics">
                        <span>WT: ${c.wt !== null ? fmt(c.wt, 1) : '—'}</span>
                        <span>RSI: ${c.rsi !== null ? fmt(c.rsi, 1) : '—'}</span>
                        <span>${c.action || '—'}</span>
                    </div>
                `;
            });

            // Signal history chart
            if (sig.history && sig.history.length > 0) {
                const chart = document.getElementById('signalChart');
                chart.innerHTML = '';
                const maxVal = Math.max(...sig.history.map(Math.abs), 1);
                sig.history.forEach(v => {
                    const bar = document.createElement('div');
                    bar.className = `chart-bar ${v > 0 ? 'positive' : v < 0 ? 'negative' : ''}`;
                    bar.style.height = `${Math.abs(v) / maxVal * 50}px`;
                    bar.title = `Score: ${v}`;
                    chart.appendChild(bar);
                });
            }

            // Snapshot count
            const snapEl = document.querySelector('.signals-panel .text-label');
            if (snapEl) snapEl.textContent = `Signal History (${sig.totalSnapshots || 0}/200 snapshots)`;
        }

        function renderPositions(data, hl) {
            const tbody = document.querySelector('.positions-panel tbody');
            const pnlDiv = document.querySelector('.pnl-divider');
            const statsDiv = document.querySelector('.quick-stats');
            if (!tbody) return;

            const positions = hl?.assetPositions || [];
            tbody.innerHTML = '';

            if (positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="padding:20px 12px;color:var(--text-secondary);text-align:center;">No open positions</td></tr>';
                pnlDiv.textContent = 'Flat — No Positions';
                pnlDiv.style.color = 'var(--text-secondary)';
            } else {
                let totalPnl = 0;
                let totalMargin = 0;
                positions.forEach(p => {
                    const pos = p.position;
                    const pnl = parseFloat(pos.unrealizedPnl || 0);
                    totalPnl += pnl;
                    totalMargin += parseFloat(pos.marginUsed || 0);
                    const isLong = parseFloat(pos.szi) > 0;
                    const rowClass = pnl >= 0 ? 'bid-row' : 'ask-row';
                    tbody.innerHTML += `<tr class="${rowClass}">
                        <td>${pos.coin}</td>
                        <td>${pos.szi}</td>
                        <td>${fmtUSD(parseFloat(pos.entryPx))}</td>
                        <td>${fmtSign(pnl)}</td>
                    </tr>`;
                });
                pnlDiv.textContent = `Unrealized: ${fmtSign(totalPnl)}`;
                pnlDiv.style.color = totalPnl >= 0 ? '#34C759' : '#FF3B30';
            }

            // Quick stats
            const hlMargin = hl ? parseFloat(hl.marginSummary?.totalMarginUsed || 0) : 0;
            const hlValue = hl ? parseFloat(hl.marginSummary?.accountValue || 0) : 0;
            if (statsDiv) {
                statsDiv.innerHTML = `
                    <div class="stat-item"><div class="text-label">Margin Used</div><div class="text-value">${fmtUSD(hlMargin)}</div></div>
                    <div class="stat-item"><div class="text-label">HL Account Value</div><div class="text-value">${fmtUSD(hlValue)}</div></div>
                    <div class="stat-item"><div class="text-label">Withdrawable</div><div class="text-value">${fmtUSD(hl ? parseFloat(hl.withdrawable || 0) : 0)}</div></div>
                `;
            }
        }

        function renderTrades(data) {
            const container = document.querySelector('.trades-content');
            if (!container || !data?.journal) return;
            container.innerHTML = '';

            const trades = data.journal.slice(0, 10); // last 10
            if (trades.length === 0) {
                container.innerHTML = '<div style="padding:20px;color:var(--text-secondary);text-align:center;">No trades yet</div>';
                return;
            }

            trades.forEach(t => {
                const time = fmtTime(t.timestamp);
                const action = t.action || '';
                const coin = t.details?.coin || '—';
                const isLong = action.includes('LONG') || action.includes('BUY');
                const isClose = action.includes('CLOSE');
                const isError = action.includes('ERROR');
                const size = t.details?.sizeUsd ? fmtUSD(t.details.sizeUsd) : (t.details?.size || '—');
                
                let statusClass = '';
                let statusText = action.replace('_ERROR', '').replace('OPEN_', '').replace('EXECUTE_SIGNAL', 'SIGNAL');
                if (isError) { statusClass = 'loss'; statusText = 'ERROR'; }
                else if (isClose) { statusClass = 'win'; statusText = 'CLOSED'; }
                else { statusText = action.replace('OPEN_', ''); }

                const dirColor = isLong ? '#34C759' : '#FF3B30';
                const dirArrow = isLong ? '▲' : '▼';
                const dirText = isLong ? 'Long' : isClose ? 'Close' : 'Short';

                container.innerHTML += `<div class="history-item">
                    <div>${time}</div>
                    <div>${coin}</div>
                    <div class="trade-direction" style="color:${dirColor}">${dirArrow} ${dirText}</div>
                    <div>${size}</div>
                    <div><span class="status-badge ${statusClass}">${statusText}</span></div>
                </div>`;
            });
        }

        function renderEngine(data) {
            const weightsDiv = document.querySelector('.engine-weights');
            const confDiv = document.querySelector('.confidence-score');
            const regimePill = document.querySelector('.regime-pill');
            if (!data?.engine) return;

            // Regime based on signal
            const sig = data.signals?.overall ?? 0;
            const action = data.signals?.action || 'NEUTRAL';
            if (regimePill) {
                regimePill.textContent = action;
                regimePill.className = 'regime-pill' + (sig < 0 ? ' bear' : '');
            }

            // Engine weights visualization
            const w = data.engine.weights || {};
            if (weightsDiv) {
                const entries = Object.entries(w).slice(0, 6); // top 6 weights
                const maxW = Math.max(...entries.map(([,v]) => Math.abs(v)), 1);
                weightsDiv.innerHTML = '<div class="text-label" style="margin-bottom:var(--space-s)">Engine Weights (52K samples)</div>';
                entries.forEach(([name, val]) => {
                    const pct = Math.abs(val) / maxW * 100;
                    const color = val >= 0 ? '#34C759' : '#FF3B30';
                    const label = name.replace(/_/g, ' ').replace('WT ', 'WT ');
                    weightsDiv.innerHTML += `<div class="weight-item">
                        <span style="font-size:10px;min-width:80px">${label}</span>
                        <div class="weight-bar"><div class="weight-fill" style="width:${pct}%;background:${color}"></div></div>
                        <span style="font-size:11px;min-width:25px;text-align:right">${val}</span>
                    </div>`;
                });
            }

            // Confidence
            if (confDiv) {
                const cal = data.engine.lastCalibration ? new Date(data.engine.lastCalibration) : null;
                const calText = cal ? cal.toLocaleDateString('en-US', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', timeZone:'UTC'}) : 'unknown';
                confDiv.innerHTML = `
                    <div class="text-label">Data Points</div>
                    <div class="text-value" style="font-size:18px;">${(data.engine.samplesUsed || 0).toLocaleString()}</div>
                    <div class="text-label" style="margin-top:var(--space-xs)">Calibrated: ${calText}</div>
                `;
            }
        }

        // ── Main Refresh Loop ──
        async function refresh() {
            const [staticData, prices, hl] = await Promise.all([
                fetchDashboardData(),
                fetchLivePrices(),
                fetchHLState(),
            ]);
            
            dashboardData = staticData;
            
            renderAccount(staticData, hl, prices);
            renderCoins(staticData, prices);
            renderSignals(staticData);
            renderPositions(staticData, hl);
            renderTrades(staticData);
            renderEngine(staticData);

            // Update timestamp
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleTimeString('en-US', { hour12:false, timeZone:'UTC', hour:'2-digit', minute:'2-digit' }) + ' UTC';
            
            // Last update indicator
            const gen = staticData?.generatedAt ? new Date(staticData.generatedAt) : null;
            if (gen) {
                const ago = Math.round((Date.now() - gen.getTime()) / 60000);
                document.getElementById('timestamp').title = `Data: ${ago}m ago`;
            }
        }

        // ── Sniper Alerts Tab ──
        function renderSniperAlerts(data) {
            const container = document.getElementById('tabContent-sniper');
            if (!container) return;
            const alerts = data?.sniper?.log?.recent || [];
            if (alerts.length === 0) {
                container.innerHTML = '<div style="padding:20px;color:var(--text-secondary);text-align:center;">No sniper alerts yet</div>';
                return;
            }
            container.innerHTML = '';
            alerts.forEach(a => {
                const time = fmtTime(a.timestamp);
                const edge = a.edge ? `${fmt(a.edge,1)}%` : '—';
                const cond = (a.edges || []).map(e => e.name).join(', ') || '—';
                container.innerHTML += `<div class="history-item" style="grid-template-columns:1fr 1fr 1fr 1fr">
                    <div>${time}</div>
                    <div style="color:${a.prediction === 'UP' ? '#34C759' : '#FF3B30'}">${a.prediction || '—'}</div>
                    <div>Edge: ${edge}</div>
                    <div style="font-size:10px;color:var(--text-secondary)">${cond}</div>
                </div>`;
            });
            // Summary at top
            const log = data?.sniper?.log || {};
            container.insertAdjacentHTML('afterbegin', `<div style="padding:12px var(--space-m);border-bottom:1px solid var(--bg-app);display:flex;gap:20px">
                <div><span class="text-label">Total Scans</span> <span class="text-value">${log.total || 0}</span></div>
                <div><span class="text-label">Snipe-Worthy</span> <span class="text-value">${log.snipeWorthy || 0}</span></div>
            </div>`);
        }

        // ── Activity Tab ──
        function renderActivity(data) {
            const container = document.getElementById('tabContent-activity');
            if (!container) return;
            const items = [];
            // Mix journal + sniper into a timeline
            (data?.journal || []).slice(0, 5).forEach(t => {
                items.push({ time: t.timestamp, text: `${t.action} ${t.details?.coin || ''} ${t.details?.sizeUsd ? fmtUSD(t.details.sizeUsd) : t.details?.size || ''}`, type: 'trade' });
            });
            if (data?.signals?.lastUpdate) {
                items.push({ time: data.signals.lastUpdate, text: `Signal: ${data.signals.action} (score: ${data.signals.overall})`, type: 'signal' });
            }
            items.sort((a, b) => new Date(b.time) - new Date(a.time));
            if (items.length === 0) {
                container.innerHTML = '<div style="padding:20px;color:var(--text-secondary);text-align:center;">No activity</div>';
                return;
            }
            container.innerHTML = '';
            items.forEach(item => {
                const colors = { trade: '#4FA3FF', signal: '#6BF3D6', sniper: '#FF6B95' };
                container.innerHTML += `<div style="padding:10px var(--space-m);border-bottom:1px solid var(--bg-app);display:flex;gap:12px;align-items:center;font-size:12px">
                    <div style="width:6px;height:6px;border-radius:50%;background:${colors[item.type] || '#8E8E93'};flex-shrink:0"></div>
                    <div style="color:var(--text-secondary);min-width:45px">${fmtTime(item.time)}</div>
                    <div>${item.text}</div>
                </div>`;
            });
        }

        // ── Nav Pill Switching ──
        document.getElementById('navPills').addEventListener('click', (e) => {
            const item = e.target.closest('.nav-item');
            if (!item) return;
            const view = item.dataset.view;
            // Update active pill
            document.querySelectorAll('#navPills .nav-item').forEach(n => n.classList.remove('active'));
            item.classList.add('active');
            // Update layout view
            const layout = document.querySelector('.layout');
            if (view === 'dashboard') {
                layout.removeAttribute('data-view');
            } else {
                layout.setAttribute('data-view', view);
            }
        });

        // ── Tab Switching ──
        document.getElementById('activityTabs').addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (!tab) return;
            const tabName = tab.dataset.tab;
            // Update active tab
            document.querySelectorAll('#activityTabs .tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            // Show/hide content
            ['trades', 'sniper', 'activity'].forEach(name => {
                const el = document.getElementById('tabContent-' + name);
                if (el) el.style.display = name === tabName ? '' : 'none';
            });
        });

        // ── Main Refresh Loop ──
        async function refresh() {
            const [staticData, prices, hl] = await Promise.all([
                fetchDashboardData(),
                fetchLivePrices(),
                fetchHLState(),
            ]);
            
            dashboardData = staticData;
            
            renderAccount(staticData, hl, prices);
            renderCoins(staticData, prices);
            renderSignals(staticData);
            renderPositions(staticData, hl);
            renderTrades(staticData);
            renderEngine(staticData);
            renderSniperAlerts(staticData);
            renderActivity(staticData);

            // Update timestamp
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleTimeString('en-US', { hour12:false, timeZone:'UTC', hour:'2-digit', minute:'2-digit' }) + ' UTC';
            
            // Last update indicator
            const gen = staticData?.generatedAt ? new Date(staticData.generatedAt) : null;
            if (gen) {
                const ago = Math.round((Date.now() - gen.getTime()) / 60000);
                document.getElementById('timestamp').title = `Data: ${ago}m ago`;
            }
        }

        // Initial load
        refresh();
        // Auto-refresh every 30 seconds
        setInterval(refresh, 30000);
        // Clock every second
        setInterval(() => {
            const now = new Date();
            document.getElementById('timestamp').textContent = now.toLocaleTimeString('en-US', { hour12:false, timeZone:'UTC', hour:'2-digit', minute:'2-digit', second:'2-digit' }) + ' UTC';
        }, 1000);
    </script>
</body>
</html>